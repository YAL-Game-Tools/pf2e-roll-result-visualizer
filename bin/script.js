// Generated by Haxe 4.3.6
(function ($global) { "use strict";
var Std = function() { };
Std.parseInt = function(x) {
	var v = parseInt(x);
	if(isNaN(v)) {
		return null;
	}
	return v;
};
var RollTable = function() {
	this.stages = [];
	this.dice = [null];
	this.element = window.document.createElement("fieldset");
	this.legend = window.document.createElement("legend");
	this.table = window.document.createElement("table");
	this.table.classList.add("results");
	var dieRow = window.document.createElement("tr");
	dieRow.classList.add("dice");
	var _g = 1;
	while(_g < 21) {
		var i = _g++;
		var die = window.document.createElement("td");
		die.width = "5%";
		die.append("" + i);
		dieRow.append(die);
		this.dice.push(die);
	}
	this.table.append(dieRow);
	var stageRow = window.document.createElement("tr");
	stageRow.classList.add("stages");
	var stage = window.document.createElement("td");
	stage.className = RollTable.stageClassNames[0];
	stageRow.append(stage);
	this.stages.push(stage);
	var stage = window.document.createElement("td");
	stage.className = RollTable.stageClassNames[1];
	stageRow.append(stage);
	this.stages.push(stage);
	var stage = window.document.createElement("td");
	stage.className = RollTable.stageClassNames[2];
	stageRow.append(stage);
	this.stages.push(stage);
	var stage = window.document.createElement("td");
	stage.className = RollTable.stageClassNames[3];
	stageRow.append(stage);
	this.stages.push(stage);
	this.table.append(stageRow);
	this.footnotes = window.document.createElement("div");
	this.element.append(this.legend,this.table,this.footnotes);
};
RollTable.create = function() {
	var table = new RollTable();
	window.document.getElementById("results").append(table.element);
	return table;
};
RollTable.prototype = {
	update: function(bonus,dc,efficiencies,firstEfficiency) {
		var chances = [0,0,0,0];
		var _g = 1;
		while(_g < 21) {
			var i = _g++;
			var r = i + bonus;
			var stage = r >= dc + 10 ? 3 : r >= dc ? 2 : r > dc - 10 ? 1 : 0;
			if(i == 20 && stage < 3) {
				++stage;
			}
			if(i == 1 && stage > 0) {
				--stage;
			}
			chances[stage] += 5;
			this.dice[i].className = RollTable.stageClassNames[stage];
		}
		var values;
		if(efficiencies != null) {
			var _g = [];
			_g.push(chances[0] / 100 * efficiencies[0]);
			_g.push(chances[1] / 100 * efficiencies[1]);
			_g.push(chances[2] / 100 * efficiencies[2]);
			_g.push(chances[3] / 100 * efficiencies[3]);
			values = _g;
		} else {
			values = null;
		}
		var _g = 0;
		while(_g < 4) {
			var i = _g++;
			var chance = chances[i];
			if(chance > 0) {
				var stageTD = this.stages[i];
				stageTD.style.display = "";
				var value = values != null ? values[i] : null;
				var valueStr = value != null ? "" + Math.round(value * 100) / 100 : null;
				var text = [chance + "%"];
				if(valueStr != null) {
					text[0] += "\n" + valueStr;
				}
				if(chances[i] > 5 || valueStr == null || valueStr.length <= 2) {
					stageTD.innerText = text[0];
					stageTD.removeAttribute("title");
					stageTD.onclick = null;
				} else {
					var short = chance + "%";
					if(valueStr != null) {
						short += "\n";
						if(value != 0) {
							short += value < 0 ? "-#" : "+#";
						} else {
							short += "0";
						}
					}
					stageTD.innerText = short;
					stageTD.title = text[0];
					stageTD.onclick = (function(text) {
						return function() {
							window.alert(text[0]);
						};
					})(text);
				}
				stageTD.colSpan = chance / 5 | 0;
			} else {
				this.stages[i].style.display = "none";
			}
		}
		var title = "Result";
		if(bonus >= 0) {
			title += " (+" + bonus + ")";
		} else {
			title += " (" + bonus + ")";
		}
		var total = 0.;
		if(efficiencies != null) {
			total += chances[0] / 100 * efficiencies[0];
			total += chances[1] / 100 * efficiencies[1];
			total += chances[2] / 100 * efficiencies[2];
			total += chances[3] / 100 * efficiencies[3];
		}
		this.legend.innerText = title;
		var notes = ["Any success: " + (chances[2] + chances[3]) + "%","any failure: " + (chances[0] + chances[1]) + "%"];
		if(efficiencies != null) {
			var efficiencyNote = "efficiency: " + total;
			if(firstEfficiency != 0) {
				var factor = "" + Math.round(total / firstEfficiency * 100 * 10) / 10;
				efficiencyNote += " (" + factor + "%)";
			}
			notes.push(efficiencyNote);
		}
		this.footnotes.innerText = notes.join("; ");
		return total;
	}
};
var Main = function() { };
Main.findInput = function(id) {
	var input = window.document.getElementById(id);
	input.addEventListener("change",function() {
		Main.update();
	});
	return input;
};
Main.update = function() {
	var bonus = Std.parseInt(Main.inBonus.value);
	var dc = Std.parseInt(Main.inDC.value);
	var attempts = Std.parseInt(Main.inAttempts.value);
	if(attempts < 1) {
		attempts = 1;
	}
	var map = Std.parseInt(Main.inMAP.value);
	var efficiencies;
	if(Main.inUseEfficiency.checked) {
		var _g = [];
		var _g1 = 0;
		var _g2 = Main.inEfficiency;
		while(_g1 < _g2.length) {
			var input = _g2[_g1];
			++_g1;
			_g.push(input.valueAsNumber);
		}
		efficiencies = _g;
	} else {
		efficiencies = null;
	}
	var firstEfficiency = 0.;
	var efficiencyTotal = 0.;
	var _g = 0;
	var _g1 = attempts;
	while(_g < _g1) {
		var attempt = _g++;
		var table = Main.tables[attempt];
		if(table == null) {
			var tmp = Main.tables;
			table = RollTable.create();
			tmp[attempt] = table;
		} else {
			table.element.style.display = "";
		}
		var efficiency = table.update(bonus,dc,efficiencies,firstEfficiency);
		if(attempt == 0) {
			firstEfficiency = efficiency;
		}
		efficiencyTotal += efficiency;
		bonus -= map;
	}
	var _g = attempts;
	var _g1 = Main.tables.length;
	while(_g < _g1) {
		var extra = _g++;
		Main.tables[extra].element.style.display = "none";
	}
	var efficiencyResult = window.document.getElementById("efficiency-result");
	if(efficiencies != null) {
		efficiencyResult.innerText = "Efficiency total: " + ("" + Math.round(efficiencyTotal * 100) / 100);
	} else {
		efficiencyResult.innerText = "";
	}
};
Main.main = function() {
	console.log("Hello!");
	var efficiencyPresets = window.document.getElementById("in-efficiency-presets");
	efficiencyPresets.addEventListener("change",function() {
		var value = efficiencyPresets.value;
		if(value == "") {
			return;
		}
		var parts = value.split("/");
		var _g_current = 0;
		var _g_array = parts;
		while(_g_current < _g_array.length) {
			var _g_value = _g_array[_g_current];
			var _g_key = _g_current++;
			var i = _g_key;
			var part = _g_value;
			Main.inEfficiency[i].value = part;
		}
		Main.update();
	});
	Main.update();
};
var haxe_iterators_ArrayIterator = function(array) {
	this.current = 0;
	this.array = array;
};
haxe_iterators_ArrayIterator.prototype = {
	hasNext: function() {
		return this.current < this.array.length;
	}
	,next: function() {
		return this.array[this.current++];
	}
};
RollTable.stageClassNames = ["crit-failure","failure","success","crit-success"];
Main.tables = [];
Main.inBonus = Main.findInput("in-bonus");
Main.inDC = Main.findInput("in-dc");
Main.inAttempts = Main.findInput("in-attempts");
Main.inMAP = Main.findInput("in-map");
Main.inUseEfficiency = Main.findInput("in-use-efficiency");
Main.inEfficiency = (function($this) {
	var $r;
	var _g = [];
	{
		_g.push(Main.findInput("in-efficiency-" + 0));
		_g.push(Main.findInput("in-efficiency-" + 1));
		_g.push(Main.findInput("in-efficiency-" + 2));
		_g.push(Main.findInput("in-efficiency-" + 3));
	}
	$r = _g;
	return $r;
}(this));
Main.main();
})({});
